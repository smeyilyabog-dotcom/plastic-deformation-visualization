//=====================Параметры кристаллической решетки======================================
  let stroki = 7;          // Количество строк в решетке
  let colonki = 21;        // Количество колонок в решетке
  let L = 35;              // Расстояние между атомами
  let X0 = 30;             // Начальная координата X для отрисовки решетки
  let Y0 = 60;             // Начальная координата Y для отрисовки решетки 

//===============Переменные для управления положением дислокацией===========================
  let d_Position = 7;             // Изначальная колонка дислокации 
  let d_vert = 4;                 // Фиксированная строка дислокации - 4-я строка
  let d_index = 0;                // Индекс текущей позиции в массиве d_dopusk
  let d_dopusk = [7, 11, 15, 19]; // Массив допустимых позиций для дислокации

  function setup() 
{
  createCanvas(800, 500);  // Создаем холст 800х600 пикслей
}

function draw() 
{
  background(255);        // Очищаем холст 
    
  /*// ==============================Отрисовка сетки==================================
  
  stroke(200); // Устанавливаем серый цвет
  strokeWeight(1); // Тонкие линии
  
  // Вертикали сетки
  for (let i = 0; i <= colonki; i++) {
    let x = X0 + i * L; // Вычисляем X-координату для каждой вертикальной линии
    line(x, Y0, x, Y0 + (stroki-1) * L); // Рисуем вертикальную линию
  }
  
  // Горизонтали сетки
  for (let j = 0; j <= stroki; j++) {
    let y = Y0 + j * L; // Вычисляем Y-координату для каждой горизонтальной линии
    line(X0, y, X0 + (colonki-1) * L, y); // Рисуем горизонтальную линию
  }
  */ 
  
//==============Определяем каждому кейсу соответствующие позиции дислокации================
  let Case;
       if (d_Position === 7) Case = 1;       // Если дислокация в колонке 7 - случай 1
  else if (d_Position === 11) Case = 2;      // Если дислокация в колонке 11 - случай 2
  else if (d_Position === 15) Case = 3;      // Если дислокация в колонке 15 - случай 3
  else if (d_Position === 19) Case = 4;      // Если дислокация в колонке 19 - случай 4
  else Case = 1;                             // По умолчанию используем случай 1
  
//==========================Выбираем матрицу конфигурации атомов==============================
  let matrica; // Матрица 7x21, где 1 - атом присутствует, 0 - атом отсутствует
  
  switch(Case) {
    case 1:                                 // Конфигурация для дислокации в позиции 7
      matrica = [
        [0,0,0,0,1,0,1,0,1,0,0,0,1,0,0,0,1,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,1,0,1,0,1,0,0,0,1,0,0,0,1,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [1,0,0,0,0,1,0,1,0,0,0,0,1,0,0,0,1,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [1,0,0,0,0,1,0,1,0,0,0,0,1,0,0,0,1,0,0,0,0]
      ];
      break;
      
    case 2:                                // Конфигурация для дислокации в позиции 11
      matrica = [
        [0,0,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,1,0,0,0,1,0,1,0,1,0,0,0,1,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [1,0,0,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [1,0,0,0,1,0,0,0,0,1,0,1,0,0,0,0,1,0,0,0,0]
      ];
      break;
      
    case 3:                               // Конфигурация для дислокации в позиции 15
      matrica = [
        [0,0,0,0,1,0,0,0,1,0,0,0,1,0,1,0,1,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,1,0,0,0,1,0,0,0,1,0,1,0,1,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [1,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1,0,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [1,0,0,0,1,0,0,0,1,0,0,0,0,1,0,1,0,0,0,0,0]
      ];
      break;
      
    case 4:                               // Конфигурация для дислокации в позиции 19
      matrica = [
        [0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1], 
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0],
        [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
        [1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0]
      ];
      break;
  }
     
//===================================Отрисовка дислокации======================================
    if (d_Position !== 19) 
  {
      let x = X0 + (d_Position - 1) * L;       // X-координата дислокации
      let y = Y0 + (d_vert - 1) * L;           // Y-координата дислокации
    
      stroke(255, 0, 0);                       // Красный цвет
      strokeWeight(4);                         // Толстые линии
      line(x, y - 15, x, y + 15);              // Вертикальная линия крестика
      line(x - 10, y + 15, x + 10, y + 15);    // Горизонтальная линия крестика
   
//====================Рисуем дополнительные черные линии вокруг дислокации==================
    stroke(0);                                 // Черный цвет
    strokeWeight(3);                           // Толстые линии
        
    line(x - 70, y - 35, x - 35, y + 35);      // Первая дополнительная линия
    line(x + 35, y + 35, x + 70, y - 35);      // Вторая дополнительная линия
  }
  
  function risovat_Linei_Mejdu_Atomami(x) {
  stroke(0);                                  // Устанавливаем черный цвет линий
  strokeWeight(3);                            // Устанавливаем толщину линий 3 пикселя
  
  let F1 = x ? stroki : colonki;
  let F2 = x ? colonki : stroki;
  
  for (let i = 0; i < F1; i++) {
    let perviy_Atom = -1;
    let posledniy_Atom = -1;
    
    for (let j = 0; j < F2; j++) {
      let Stroka = x ? i : j;
      let Stolb = x ? j : i;
      
      if (matrica[Stroka][Stolb] === 1) {
        if (perviy_Atom === -1) perviy_Atom = j;
        posledniy_Atom = j;
      }
    }
    
    if (perviy_Atom !== posledniy_Atom) 
    {
        if (x) {
        line(X0 + perviy_Atom*L, Y0 + i*L, X0 + posledniy_Atom*L, Y0 + i*L);
      } else {
        line(X0 + i*L, Y0 + perviy_Atom*L, X0 + i*L, Y0 + posledniy_Atom*L);
      }
    }
  }
}
  risovat_Linei_Mejdu_Atomami(true);        // Горизонтальные линии
  risovat_Linei_Mejdu_Atomami(false);       // Вертикальные линии
  
  //===================================Отрисовка атомов========================================
  fill(100, 150, 250);                      // Голубой цвет для атомов
  noStroke(); // Без обводки
  
  for (let Stroka = 0; Stroka < stroki; Stroka++) {
    for (let Stolb = 0; Stolb < colonki; Stolb++) {
      if (matrica[Stroka][Stolb] === 1)    // Если в ячейке есть атом
      { 
        let x = X0 + Stolb * L;            // X-координата атома
        let y = Y0 + Stroka * L;           // Y-координата атома
        ellipse(x, y, 20);                 // Рисуем атом диаметром 20 пикселей
      }
    }
  }
   
  //=================================Заголовок схемы================================
  fill(0);                                // Черный цвет текста
  noStroke();
  textSize(25);
  textAlign(CENTER);  
  text("Схема пластического сдвига в кристалле", width/2, 30);
    
 //=====================================Сноски=======================================
  let Y_snoska = Y0 + stroki * L + 40; // Позиция Y 
    // Атом
  fill(100, 150, 250);
  ellipse(50, Y_snoska, 20);
  fill(0);
  noStroke();
  textSize(14);
  textAlign(LEFT);
  text(" - Атом", 65, Y_snoska + 5);
    // Дислокация
  stroke(255, 0, 0);
  strokeWeight(3);
  line(150, Y_snoska - 8, 150, Y_snoska + 8);
  line(145, Y_snoska + 8, 155, Y_snoska + 8);
  noStroke();
  fill(0);
  text(" - Дислокация", 155, Y_snoska + 5);
    // Связь
  stroke(0);
  strokeWeight(3);
  line(280, Y_snoska, 310, Y_snoska);
  noStroke();
  fill(0);
  text(" - Связь между атомами", 315, Y_snoska + 5);

}

  //==========================Обработчик нажатия клавиш============================
function keyPressed() {
  if (key === ' ') 
  { // Если нажат пробел
    // Переключаемся на следующую позицию в массиве d_dopusk
    d_index = (d_index + 1) % d_dopusk.length;
    // Устанавливаем новую позицию дислокации
    d_Position = d_dopusk[d_index];
  }
}
